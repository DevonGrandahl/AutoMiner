<html>
	<script src="perlin.js"></script>
	<script>
		var mineData = [];
		
		var smoothness = 15; // Noise Scale. Lower numbers give more peaks.
		var cellSize = 20;
		var mineWidth = 20;
		var mineHeight = 500;
		
		var currentRowOffset = 0;
		var maxDisplayRows = 30;
		
		var tableString = "";
		var table;
		var character;
		
		var walkSpeed = 1;
		var currentH;
		var currentW;
		
		var points = 0;
		
		var tileTypes = [
			{name: 'Dirt', color: '#52240c', value: 0, rarity: 0, minDepth: 0, maxDepth: 999},
			{name: 'DarkDirt', color: '#502008', value: 0, rarity: .6, minDepth: 0, maxDepth: 999},
			{name: 'Grass', color: '#6cd900', value: 0, rarity: 0, minDepth: 0, maxDepth: 0},
			//valuables
			{name: 'Coal', color: '#313140', value: 1, rarity: .8, minDepth: 6, maxDepth: 300},
			{name: 'Copper', color: '#da8a67', value: 2, rarity: .83, minDepth: 27, maxDepth: 300},
			{name: 'Silver', color: '#bbbbcc', value: 3, rarity: .88, minDepth: 120, maxDepth: 330},
			{name: 'Gold', color: '#cccc33', value: 4, rarity: .87, minDepth: 250, maxDepth: 500},
			{name: 'Diamond', color: '#cfe4ee', value: 6, rarity: .96, minDepth: 400, maxDepth: 500},
			{name: 'Verderald', color: '#26ff5c', value: 8, rarity: .96, minDepth: 450, maxDepth: 500},
			{name: 'Bedrock', color: '#0f0f1e', value: 0, rarity: 0, minDepth: 497, maxDepth: 999}
		];
		
		function getTypeFromName(name){
			return tileTypes.find( (e) => {return e.name == name;} );
		}
		
		function init(){
			table = document.getElementById("table");
			character = document.getElementById("character");
			generateMine();
			drawTable();
			startAI();
		}
		
		function generateMine(){
			tileTypes.forEach( (type) => {
				noise.seed(Math.random());
				for (var h = 0; h < mineHeight; h++) {
					if (!mineData[h]){
						mineData[h] = [];
					}
					
					for (var w = 0; w < mineWidth; w++) {
						if (h >= type.minDepth && 
							h <= type.maxDepth && 
							Math.abs(noise.simplex2(h / smoothness, w / smoothness)) >= type.rarity
						){
							mineData[h][w] = {id: h + "_" + w, h: h, w: w, type: type, empty: false};
						}
					}
				}
			});
		}

		function drawTable(){
			tableString = "<tr>";

			for (var h = currentRowOffset; h < currentRowOffset + maxDisplayRows - 1; h++) {
			  for (var w = 0; w < mineWidth; w++) {
				tileData = mineData[h][w];
				tableString += getCellString(tileData);
			  }
			  tableString += "</tr><tr>";
			}
			tableString+= "</tr>";
			document.getElementById("table").innerHTML = tableString;
		}
		
		function getCellString(tileData){
			return "<td" + 
			" id='" + tileData.h + "_" + tileData.w + "'" +
			" style='" + getStyle(tileData) + "'" +
			" title='" + tileData.type.name + "'" +
			" onClick='handleClick(" + tileData.h + ", " + tileData.w + ")'" +
			">" +
			'' + 
			"</td>";
		}
		
		function getStyle(tileData){
			var styleObject = {};
			styleObject['width'] = cellSize + "px";
			styleObject['height'] = cellSize + "px";
			styleObject['opacity'] = tileData.empty ? ".1" : "1";
			styleObject['background-color'] = tileData.type.color;
			styleObject['color'] = "white";
			styleObject['background-image'] = 'url(data:image/png;base64,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)';

			
			var styleString;
			styleString = Object.entries(styleObject).reduce((styleString, [propName, propValue]) => {
				return `${styleString}${propName}:${propValue};`;
			}, '')
			
			return styleString;
		}
		
		function handleClick(h, w){
			Dig(h, w);
		}
		
		function Dig(h, w){
			mineData[h][w].empty = true;
			points += mineData[h][w].type.value;
			document.getElementById("points").innerHTML = "Points: " + points;
			drawTable();
		}
		
		function changeOffset(amount) {
			currentRowOffset = clamp(0, mineHeight - maxDisplayRows, currentRowOffset + amount);
			drawTable();
		}
		
		function clamp(min, max, val){
			return Math.min(Math.max(val, min), max);
		}
		
		function startAI(){
			moveCharacter("0_" + (mineWidth / 2));
		}
		

		function getCharacterDistanceToTile(h, w){
			var tile = document.getElementById(h + "_" + w);
			distX = tile.offsetLeft - character.offsetLeft;
			distY = tile.offsetTop - character.offsetTop;
			distance = Math.sqrt(distX*distX + distY*distY);
			return distance;
		}
		
		function moveCharacter(tileId){
			console.log(tileId);
			var tileElement = document.getElementById(tileId);
			
			var posY = character.offsetTop - 20;
			var posX = character.offsetLeft;
			var interval = setInterval(frame, 10);
			function frame() {
				if (!document.body.contains(tileElement)){
					tileElement = document.getElementById(tileId);
				}
				
				// Check if we are at the tile
				if (checkPosition(posX, tileElement.offsetLeft, posY, tileElement.offsetTop)) {
					clearInterval(interval);
					/*setTimeout(function() {
						actOnTile(tile);
						chooseNextAIAction();
						drawInfoString();
					}, workSpeed); */
					
					
					
					currentH = parseInt(tileId.split("_")[0]);
					currentW = parseInt(tileId.split("_")[1]);
					
					if (currentH >= currentRowOffset + maxDisplayRows - 2){
						changeOffset(10);
						character.style.top = document.getElementById(tileId).offsetTop;
					}
					
					if (currentH > 2 && currentH < currentRowOffset + 2){
						changeOffset(-10);
						character.style.top = document.getElementById(tileId).offsetTop;
					}
					
					Dig(currentH, currentW);
					
					var r = Math.random();
					
					if (r > .8 && currentW < mineWidth - 1){
						moveCharacter(currentH + "_" + (currentW + 1));
					} else if (r > .6 && currentW > 0){
						moveCharacter(currentH + "_" + (currentW - 1));
					} else if (r > .45 && currentH > 0){
						moveCharacter((currentH - 1) + "_" + currentW);
					} else {
						moveCharacter((currentH + 1) + "_" + currentW);
					}
					
					
					
				} else {
					if (posY < tileElement.offsetTop){
						character.style.top = (posY += walkSpeed) ;
					} else if (posY > tileElement.offsetTop){
						character.style.top = (posY -= walkSpeed);
					}
					 
					if (posX < tileElement.offsetLeft){
						character.style.left = (posX += walkSpeed);
					} else if (posX > tileElement.offsetLeft){
						character.style.left = (posX -= walkSpeed);
					}
				}
			}	
		}
		
		function checkPosition(x, x2, y, y2){
			return (Math.abs(x - x2) + Math.abs(y-y2)) < (walkSpeed + .1);
		}
	
		
		
	</script>
	<style>		
		.character {
			position: fixed;
			top: 0px;
			left: 0px;
			z-index: 2;
			color: #FFFFFF;
			font-size: 16pt;
			font-weight: bold;
			padding-top: 2px;
			padding-left: 12px;
			pointer-events:none;
		}
	</style>
	<body style="overflow: hidden;" onload="init();">
		<div>
			<span id="points" class="points">Points: 0</span>
		</div>
		<table cellspacing="0" style="padding:0px; background-color: #200701" id="table">
		</table>
		<p id="character" class="character">â– </p>
	</body>
</html>
